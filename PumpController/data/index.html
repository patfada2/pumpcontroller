<!DOCTYPE html>
<html lang="en">
<head>
  <title>Pump Controller</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/stock/modules/stock.js"></script>

	<title>Pump Controller</title>
	
	
</head>
<body>


	<!- <div class="container  border border-primary"> -->
	<div class="container-fluid min-vh-100 d-flex flex-column">	

		<div class="row row bg-primary  pt-3">
        	<div class="col-sm-2  border border-primary">
        
        		<div class="dropdown">
					<button type="button" class="btn btn-dark dropdown-toggle" data-bs-toggle="dropdown">
						Menu
					</button>
					<ul class="dropdown-menu">

						<li><a class="dropdown-item" href="javascript:readVoltage();">Read Voltage</a></li>
						<li><a class="dropdown-item" href="javascript:readRelayState();">Read Relay State</a></li>	
						<li><a class="dropdown-item" href="javascript:getElapsed();">Read Time Elapsed</a></li>							
						<li><a class="dropdown-item" href="javascript:getHistory();">Load History</a></li>
						<li><a class="dropdown-item" href="javascript:clearHistory();">Clear History</a></li>
						<li><a class="dropdown-item" href="javascript:getConfig();">Load Config</a></li>
						<li><a class="dropdown-item" href="./webserial">View logs</a></li>
						<li><a class="dropdown-item" href="./update">Update</a></li>
						
					</ul>
				</div>
             </div>
             <div class="col-sm-10  border border-primary">
             	<H1>Pump Controller</H1>
             </div>
        </div>
	

		<div class="row bg-light  border border-primary">
			<div class="col-sm-2  border border-primary pt-3">
				<div class="row mb-3">  <button type="button" class="btn btn-outline-primary w-100" onclick="toggleRelay2()">Pump on/off</button></div>
				<div class="row mb-3">  <button type="button" class="btn btn-outline-primary w-100" onclick="editConfig()">Edit Config</button></div>
			</div>
			<div class="col-sm-7 bg-white" id="Middle">
				<div class="row mb-3  border border-primary pt-3""><div id="chart-voltage" class="container"></div></div>
				<div class="row mb-3  border border-primary pt-3""><div id="chart-status" class="container"></div></div>
			</div>
			<div class="col-sm-3  border border-primary" id="right">
				<div class="row mb-3"></div>

				<div class="row mb-3">
					<label for="volts" class="col-sm-6 col-form-label col-form-label-sm">Volts</label>
					<div class="col-sm-6"><input type="email" class="form-control form-control-sm" name="voltage_reading" placeholder="xx"></div>				
	
				</div>

				<div class="row mb-3">
						<label for="relay1" class="col-sm-6 col-form-label col-form-label-sm">AC Power In</label>
						<div class="col-sm-6"><input type="text" class="form-control form-control-sm" name="ac_state" placeholder="on/off"></div>				
				</div>
								
				<div class="row mb-3">
					<label for="AC" class="col-sm-6 col-form-label col-form-label-sm">Power to Pump</label>
					<div class="col-sm-6"><input type="text" class="form-control form-control-sm" name="relay_state" placeholder="on/off"></div>				
				</div>

				<div class="row mb-3">
					<label for="timeOn" class="col-sm-6 col-form-label col-form-label-sm">Time on</label>
					<div class="col-sm-6"><input type="text" class="form-control form-control-sm" name="timeOn" placeholder="yyy"></div>
				</div>

				<div class="row mb-3">
					<label for="timeLeft" class="col-sm-6 col-form-label col-form-label-sm">Time elapsed</label>
					<div class="col-sm-6"><input type="text" class="form-control form-control-sm" name="timeLeft" placeholder="ttt"></div>
				</div>
				
				<div class="row mb-3">
					<label for="manualMode" class="col-sm-6 col-form-label col-form-label-sm">Manual mode</label>
					<div class="col-sm-6"><input type="text" class="form-control form-control-sm" name="manualMode" placeholder="ttt"></div>
				</div>

				

				<div class="row mb-3">  <button type="button" class="btn btn-outline-primary"   onclick="getData()">Refresh</button></div>

	</div>

		
	</div>

	<div class="row row bg-secondary  border border-primary">
     	<div class="col-sm-2">
     		<H6>source:  <a class ="text-light" href="https://github.com/patfada2/pumpcontroller"> github</a></H6>
        </div>
        <div class="col-sm-10 text-light" id="log">
     		...
        </div>
        
     </div>
	 


<div id="myModal" class="modal" data-bs-backdrop="static" role="dialog">
  <div class="modal-dialog">
  <div class="modal-content">
<div class="container">
  
  <form class="form-horizontal bg-light p-4"   action="javascript:saveConfig()">
	 <div class="form-group row">
		<label for="interval" class="col-sm-4 col-form-label mr-2">Interval</label>
		<div class="col-sm-8">
			<input type="number" class="form-control" id="interval" name="interval"  placeholder="xx">
		</div>
	</div>
	
	 <div class="form-group row">
		<label for="vOn" class="col-sm-4 col-form-label mr-2">V On</label>
		<div class="col-sm-8">
			<input type="number step="0.01" " class="form-control" id="vOn" name="vOn"  placeholder="x">
		</div>
	</div>
	<div class="form-group row">
		<label for="vOff" class="col-sm-4 col-form-label mr-2">V Off</label>
		<div class="col-sm-8">
			<input type="number" step="0.01"  class="form-control" id="vOff" name="vOff"  placeholder="x">
		</div>
	</div>
	<div class="form-group row">
		<label for="maxSecondsOnPerDay" class="col-sm-4 col-form-label mr-2">Max seconds on per day</label>
		<div class="col-sm-8">
			<input type="number" class="form-control" id="maxSecondsOnPerDay" name="maxSecondsOnPerDay"  placeholder="x">
		</div>
	</div>
	<div class="form-group row">
		<label for="vcal" class="col-sm-4 col-form-label mr-2">Voltage calibration</label>
		<div class="col-sm-8">
			<input type="number" class="form-control" id="vcal" name="vcal"  placeholder="x">
		</div>
	</div>
    <div class="form-group row">
		<label for="numSamples" class="col-sm-4 col-form-label mr-2">Number of samples</label>
		<div class="col-sm-8">
			<input type="number" class="form-control" id="numSamples" name="numSamples"  placeholder="x">
		</div>
	</div>
	 <div class="form-group row">
		<label for="isManual" class="col-sm-4 col-form-label mr-2">Manual Mode</label>
		<div class="col-sm-8">
			 <input class="form-check-input" type="checkbox" name="isManual" id="isManual" >
		</div>
	</div>
	
	
    <div class="form-group">      
		<div class="row pt-3">
			  <div class="col-sm-10 ">
				<button type="submit" class="btn btn-outline-primary"  >save</button>
			  </div>
			  <div class="col-sm-2">
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			  </div>
		</div>
	</div>
  </form>
</div>

</div>
</div>
</div>

<script>

	 class PCConfig {	 
		 interval=0;
		 vOn=0.0;
		 vOff=0.0;
		 maxSecondsOnPerDay=0;
		 vcal=0;
		 numSamples=0;
		 isManual=false;
		 
		  // The constructor method is a special method for creating and initializing an object created with a class.
		  constructor(interval,vOn,vOff,maxSecondsOnPerDay,vcal,numSamples,isManual ) {
			this.interval = interval;
			this.vOn = vOn;
			this.vOff = vOff;
			this.maxSecondsOnPerDay = maxSecondsOnPerDay;
			this.vcal = vcal;
			this.numSamples = numSamples;
			this.isManual = isManual;
		  }
		}  
	
	var pcConfig=new PCConfig(0,0,0,0,0,0,false);

	setInterval(getData, 30000);

	var chartT = new Highcharts.stockChart('chart-voltage', {
		chart: {
			time: {
				timezone: 'Pacific/Auckland'
			},
			type: 'line',
			zooming: {
				type: 'xy'
			},
			panning: {
				enabled: true,
				type: 'xy'
			},
			panKey: 'shift',
			spacingBottom: 0
		},
		rangeSelector: {

			allButtonsEnabled: true,
			buttons: [
				{
					type: 'hour',
					count: 3,
					text: 'Minute',
					dataGrouping: {
						forced: true,
						units: [['minute', [1]]]
					}
				},
				{
					type: 'day',
					count: 3,
					text: 'Hour',
					dataGrouping: {
						forced: true,
						units: [['hour', [1]]]
					}
				}, {
					type: 'month',
					count: 3,
					text: 'Day',
					dataGrouping: {
						forced: true,
						units: [['day', [1]]]
					}
				}, {
					type: 'year',
					count: 1,
					text: 'Week',
					dataGrouping: {
						forced: true,
						units: [['week', [1]]]
					}
				}, {
					type: 'all',
					text: 'All'

				}],
			buttonTheme: {
				width: 60
			},
			selected: 4
		},

		title: {
			text: 'Battery Voltage'
		},
		subtitle: {
			text: 'Click and drag to zoom in. Hold down shift key to pan in both ' +
				'directions.'
		},
		series: [{
			name: 'volts',
			showInLegend: false,			
			data: [],
			dataLabels: {
				enabled: true,
				format: '{y:.2f}' // Formats y-value to 2 decimal places
			},
			yAxis: 0,

			color: Highcharts.getOptions().colors[1],
		}],
		plotOptions: {
			line: {
				animation: false,
				dataLabels: {enabled: true}
			}
		},
		xAxis: {
			type: 'datetime',
			dateTimeLabelFormats: {second: '%H:%M:%S'}
		},
		yAxis: [{
			opposite: false,
			lineWidth: 1,

			title: {
				text: 'Volts'
			},
			min: 0,
			max: 20
			
		}],
		credits: {enabled: false}
	});

	var chartT2 = new Highcharts.stockChart('chart-status', {
		chart: {
			time: {
				timezone: 'Pacific/Auckland'
			},
			type: 'line',
			zooming: {
				type: 'xy'
			},
			panning: {
				enabled: true,
				type: 'xy'
			},
			panKey: 'shift',
			spacingBottom: 0
			
		},
		rangeSelector: {

			allButtonsEnabled: true,
			buttons: [
				{
					type: 'hour',
					count: 3,
					text: 'Minute',
					dataGrouping: {
						forced: true,
						units: [['minute', [1]]]
					}
				},
				{
					type: 'day',
					count: 3,
					text: 'Hour',
					dataGrouping: {
						forced: true,
						units: [['hour', [1]]]
					}
				}, {
					type: 'month',
					count: 3,
					text: 'Day',
					dataGrouping: {
						forced: true,
						units: [['day', [1]]]
					}
				}, {
					type: 'year',
					count: 1,
					text: 'Week',
					dataGrouping: {
						forced: true,
						units: [['week', [1]]]
					}
				}, {
					type: 'all',
					text: 'All'

				}],
			buttonTheme: {
				width: 60
			},
			selected: 4
		},

		title: {
			text: 'Relay State'
		},
		subtitle: {
			text: 'Click and drag to zoom in. Hold down shift key to pan in both ' +
				'directions.'
		},
		series: [
		{
			name: 'relay_state',
			showInLegend: false,
			data: [],	
			dataLabels: {
				enabled: true,
			    //format: '{y:.2d}' 
			},
			yaxis: 0,
			color: Highcharts.getOptions().colors[2],
				
		
		}],
		plotOptions: {
			line: {
				animation: false,
				dataLabels: {enabled: true}
			}
		},
		xAxis: {
			type: 'datetime',
			dateTimeLabelFormats: {second: '%H:%M:%S'}
		},
		yAxis: [ {
			lineWidth: 1,
			color: Highcharts.getOptions().colors[2],
			opposite: false,
			title: {
				text: 'Relay Off/On'
			},
			min: -0.1,
			max: 1.1
		}],
		credits: {enabled: false}
	});
	
	function log(msg) {
    	document.getElementById("log").innerHTML = msg;
    }


	function getData() {
		readVoltage();
		readState();
		getElapsed();
		getManualMode();
	}


	function getVoltageHistory() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {

				const json = xhttp.responseText;
				const obj = JSON.parse(json);
				chartT.series[0].setData(obj);

				log("loaded voltage history");

			}
		};
		xhttp.open("GET", "/GET_VOLT_HISTORY", true);
		xhttp.send();
	};

	function getStateHistory() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {

				const json = xhttp.responseText;

				const obj = JSON.parse(json);
				chartT2.series[0].setData(obj);
				log("loaded state history");

			}
		};
		xhttp.open("GET", "/GET_STATE_HISTORY", true);
		xhttp.send();
	};

	function clearVoltageHistory() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				
				log("cleared voltage history");
				if (chartT.series.length) {
					chartT.series[0].setData([]);
				}

			}
		};
		xhttp.open("GET", "/CLEAR_VOLT_HISTORY", true);
		xhttp.send();
	};

	function clearRelayStateHistory() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {				
				log("cleared relay state history");
				if (chartT2.series.length) {
					chartT2.series[0].setData([]);
				}

			}
		};
		xhttp.open("GET", "/CLEAR_RELAY_STATE_HISTORY", true);
		xhttp.send();
	};



	function readVoltage() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				// Typical action to be performed when the document is ready:
				const json = xhttp.responseText;
				const obj = JSON.parse(json);
				chartT.series[0].addPoint(obj);

				document.getElementsByName("voltage_reading")[0].placeholder=obj.y;				
			}
		};
		xhttp.open("GET", "/GET_VOLTAGE", true);
		xhttp.send();		

	};

	function getElapsed() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				const json = xhttp.responseText;
				const obj = JSON.parse(json);
				document.getElementsByName("timeLeft")[0].placeholder=obj.secondsElapsed;			
				document.getElementsByName("timeOn")[0].placeholder=obj.secondsOn;
			}
		};
		xhttp.open("GET", "/GET_ELAPSED", true);
		xhttp.send();
	};
	
	function getManualMode() {
		if (pcConfig.isManual) 
			document.getElementsByName("manualMode")[0].placeholder="on";		
		else
					document.getElementsByName("manualMode")[0].placeholder="off";		
	}

	function getHistory() {
		getStateHistory();
		getVoltageHistory();
	}

	function clearHistory() {
		clearVoltageHistory();
		clearRelayStateHistory();
	}

	function readState() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				
				const json = xhttp.responseText;
				const obj = JSON.parse(json);
				chartT2.series[0].addPoint(obj.y, obj.x);
				
				document.getElementsByName("relay_state")[0].placeholder= obj.state;	
				document.getElementsByName("ac_state")[0].placeholder= obj.AC;					
			}
		};
		xhttp.open("GET", "/GET_STATE", true);
		xhttp.send();
	};

	function toggleRelay() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {			
				log(xhttp.responseText);			
				getData();}
		};
		xhttp.open("GET", "/TOGGLE_RELAY", true);
		xhttp.send();
	};

    function toggleRelay2() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                log(xhttp.responseText);
                getData();
            }
        };
        xhttp.open("GET", "/TOGGLE_RELAY2", true);
        xhttp.send();
    };

	function getConfig() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {

				log(xhttp.responseText);
				const json = xhttp.responseText;
				pcConfig = JSON.parse(json);
							
			} 
			else 
				pcConfig=new PCConfig(0,0,0,0,0,0);
				log("connection to pump controller failed");
		};
		xhttp.open("GET", "/GET_CONFIG", true);
		xhttp.send();
	};

	
	function saveConfig() {
	
	    pcConfig.interval = document.getElementById("interval").value;
		pcConfig.vOn = document.getElementById("vOn").value;
		pcConfig.vOff = document.getElementById("vOff").value; 
		pcConfig.maxSecondsOnPerDay = document.getElementById("maxSecondsOnPerDay").value;
		pcConfig.vcal = document.getElementById("vcal").value;
		pcConfig.numSamples = document.getElementById("numSamples").value;
		pcConfig.isManual=document.getElementById("isManual").checked;
		
		
		const xhr = new XMLHttpRequest();
		const url = "/SAVE_CONFIG"; 
					
        json = JSON.stringify(pcConfig);
		console.log(json);
		

		xhr.open('POST', url, true); // Method, URL, Asynchronous (true)
		xhr.setRequestHeader('Content-Type', 'application/json'); // Set the content type for JSON data

		xhr.onreadystatechange = function () {
			if (xhr.readyState === XMLHttpRequest.DONE) {
				if (xhr.status === 200) {
					// Request was successful
					console.log('Response:', xhr.responseText);
				} else {
					// There was an error
					console.error('Error:', xhr.status, xhr.statusText);
				}
			}
		};

		xhr.onerror = function () {
			console.error('Network error occurred.');
		};

		xhr.send(json); // Send the data, stringified for JSON
		log("saved config");
		
		
	};

	function editConfig() {
	  const myModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('myModal'));
	  document.getElementById("interval").value = pcConfig.interval;
		document.getElementById("vOn").value = pcConfig.vOn; 
		document.getElementById("vOff").value = pcConfig.vOff; 
		document.getElementById("maxSecondsOnPerDay").value = pcConfig.maxSecondsOnPerDay;
		document.getElementById("vcal").value = pcConfig.vcal;
		document.getElementById("numSamples").value =  pcConfig.numSamples;
		document.getElementById("isManual").value =  pcConfig.isManual;
		myModal.show();
	  
	}

	/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
	function dropdown() {
		document.getElementById("myDropdown").classList.toggle("show");
	}

	// Close the dropdown if the user clicks outside of it
	window.onclick = function (event) {
		if (!event.target.matches('.dropbtn')) {
			var dropdowns = document.getElementsByClassName("dropdown-content");
			var i;
			for (i = 0; i < dropdowns.length; i++) {
				var openDropdown = dropdowns[i];
				if (openDropdown.classList.contains('show')) {
					openDropdown.classList.remove('show');
				}
			}
		}
	}
	window.onload = function () {
		getHistory();
		getConfig();
		getData();
		
	};


</script>

</html>