<!DOCTYPE HTML>
<html>
<!-- Rui Santos - Complete project details at https://RandomNerdTutorials.com

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files.
The above copyright notice and this permission notice shall be included in all
<!DOCTYPE HTML><html>
<!-- Rui Santos - Complete project details at https://RandomNerdTutorials.com

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files.
The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software. -->

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://code.highcharts.com/highcharts.js"></script>
	<script src="https://code.highcharts.com/stock/modules/stock.js"></script>
	<style>
		body {
			min-width: 310px;
			max-width: 800px;
			height: 400px;
			margin: 0 auto;
		}

		h2 {
			font-family: Arial;
			font-size: 2.5rem;
			text-align: center;
		}

		.dropbtn {
			background-color: #3498DB;
			color: white;
			padding: 16px;
			font-size: 16px;
			border: none;
			cursor: pointer;
		}

		.dropbtn:hover,
		.dropbtn:focus {
			background-color: #2980B9;
		}

		.dropdown {
			position: relative;
			display: inline-block;
		}

		.dropdown-content {
			display: none;
			position: absolute;
			background-color: #f1f1f1;
			min-width: 160px;
			overflow: auto;
			box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
			z-index: 1;
		}

		.dropdown-content a {
			color: black;
			padding: 12px 16px;
			text-decoration: none;
			display: block;
		}

		.dropdown a:hover {
			background-color: #ddd;
		}

		.show {
			display: block;
		}
	</style>
</head>

<body>
	<h2>Pump Controller</h2>
	<div class="dropdown">
		<button onclick="dropdown()" class="dropbtn">...</button>
		<div id="myDropdown" class="dropdown-content">
			<a href="javascript:readVoltage();">Read Voltage</a>
			<a href="javascript:readRelayState();">Read Relay State</a>
			<a href="javascript:toggleRelay();">Toggle Relay</a>
			<a href="javascript:getHistory();">Load History</a>
			<a href="javascript:clearHistory();">Clear History</a>		
		</div>
	</div>


	<p id="history"></p>

	<b id="voltage_reading"></b><br>
	<b id="relay_state"></b>

	<div id="chart-voltage" class="container"></div>


</body>

</body>
<script>

	setInterval(getData, 30000);
	
	var chartT = new Highcharts.stockChart('chart-voltage', {
		chart: {
			time: {
				timezone: 'Pacific/Auckland'
			},
			type: 'line',
			zooming: {
				type: 'xy'
			},
			panning: {
				enabled: true,
				type: 'xy'
			},
			panKey: 'shift'
		},
		rangeSelector: {
		
			allButtonsEnabled: true,
			buttons: [
				{
					type: 'hour',
					count: 3,
					text: 'Minute',
					dataGrouping: {
						forced: true,
						units: [['minute', [1]]]
					}
				},
				{
					type: 'day',
					count: 3,
					text: 'Hour',
					dataGrouping: {
						forced: true,
						units: [['hour', [1]]]
					}
				}, {
					type: 'month',
					count: 3,
					text: 'Day',
					dataGrouping: {
						forced: true,
						units: [['day', [1]]]
					}
				}, {
					type: 'year',
					count: 1,
					text: 'Week',
					dataGrouping: {
						forced: true,
						units: [['week', [1]]]
					}
				}, {
					type: 'all',
					text: 'All'
					
				}],
			buttonTheme: {
				width: 60
			},
			selected: 4
		},

		title: {
			text: 'Battery Voltage and Relay State'
		},
		subtitle: {
			text: 'Click and drag to zoom in. Hold down shift key to pan in both ' +
				'directions.'
		},
		series: [{
			showInLegend: true,
			data: [],

			color: Highcharts.getOptions().colors[1],
		},
		{
			showInLegend: true,
			data: [],
			yaxis: 1,
			color: Highcharts.getOptions().colors[2],
		}],
		plotOptions: {
			line: {
				animation: false,
				dataLabels: {enabled: true}
			}
		},
		xAxis: {
			type: 'datetime',
			dateTimeLabelFormats: {second: '%H:%M:%S'}
		},
		yAxis: [{
		opposite: false,
        lineWidth: 1,
		
        title: {
            text: 'Volts'
        }
    }, {
        lineWidth: 1,
		color: Highcharts.getOptions().colors[2],
        opposite: true,
        title: {
            text: 'Relay Off/On'
        }
    }],
		credits: {enabled: false}
	});
	
	function getData() {
		readVoltage();
		readRelayState();
	}
	

	function getVoltageHistory() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {

				const json = xhttp.responseText;
				const obj = JSON.parse(json);
				chartT.series[0].setData(obj);

				document.getElementById("history").innerHTML = "loaded voltage history";

			}
		};
		xhttp.open("GET", "/GET_VOLT_HISTORY", true);
		xhttp.send();
	};
	
	function getStateHistory() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {

				const json = xhttp.responseText;
				
				const obj = JSON.parse(json);
				chartT.series[1].setData(obj);

				document.getElementById("history").innerHTML = "loaded state history";

			}
		};
		xhttp.open("GET", "/GET_STATE_HISTORY", true);
		xhttp.send();
	};

	function clearVoltageHistory() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				document.getElementById("history").innerHTML = "cleared voltage history";
				if (chartT.series.length) {
					chartT.series[0].setData([]);
				}

			}
		};
		xhttp.open("GET", "/CLEAR_VOLT_HISTORY", true);
		xhttp.send();
	};

	function clearRelayStateHistory() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				document.getElementById("history").innerHTML = "cleared relay state history";
				if (chartT.series.length) {
					chartT.series[0].setData([]);
				}

			}
		};
		xhttp.open("GET", "/CLEAR_RELAY_STATE_HISTORY", true);
		xhttp.send();
	};



	function readVoltage() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				// Typical action to be performed when the document is ready:
				const json = xhttp.responseText;
				const obj = JSON.parse(json);

				document.getElementById("voltage_reading").innerHTML = "volts: "+obj.y;

			}
		};
		xhttp.open("GET", "/GET_VOLTAGE", true);
		xhttp.send();
	};
	
	function getHistory() {
		getStateHistory();
		getVoltageHistory();
	}
	
	function clearHistory() {
		clearVoltageHistory();
		clearRelayStateHistory();
	}
	
	function readRelayState() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {				
				document.getElementById("voltage_reading").innerHTML =  "relay :"+xhttp.responseText;
			}
		};
		xhttp.open("GET", "/GET_RELAY_STATE", true);
		xhttp.send();
	};
	
	function toggleRelay() {
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				
				document.getElementById("relay_state").innerHTML =  "relay :"+xhttp.responseText;
			}
		};
		xhttp.open("GET", "/TOGGLE_RELAY", true);
		xhttp.send();
	};


	/* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
	function dropdown() {
		document.getElementById("myDropdown").classList.toggle("show");
	}

	// Close the dropdown if the user clicks outside of it
	window.onclick = function (event) {
		if (!event.target.matches('.dropbtn')) {
			var dropdowns = document.getElementsByClassName("dropdown-content");
			var i;
			for (i = 0; i < dropdowns.length; i++) {
				var openDropdown = dropdowns[i];
				if (openDropdown.classList.contains('show')) {
					openDropdown.classList.remove('show');
				}
			}
		}
	}



</script>

</html>